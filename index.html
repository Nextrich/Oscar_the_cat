<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Å–∫–∞—Ä - –ß–µ—Ä–Ω—ã–π –∫–æ—Ç–∏–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø—Ä–∏–º–µ—Ä–µ */
        /* ... */
    </style>
</head>
<body>
    <!-- HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–æ–π –∂–µ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø—Ä–∏–º–µ—Ä–µ -->
    <!-- ... -->
    
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const API_BASE_URL = "http://–í–ê–®_–ü–£–ë–õ–ò–ß–ù–´–ô_IP:8080/api";
        // –ò–õ–ò –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok/cloudflare tunnel:
        // const API_BASE_URL = "https://–≤–∞—à-ngrok-—Ç—É–Ω–Ω–µ–ª—å.ngrok.io/api";
        
        // Telegram Web App
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.BackButton.show();
        tg.BackButton.onClick(() => {
            tg.close();
        });
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –û—Å–∫–∞—Ä–∞
        let oscarState = {
            hunger: 100,
            energy: 100,
            mood: 100,
            lives: 24,
            isSleeping: false
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async function() {
            await loadOscarState();
            startAnimations();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const user = tg.initDataUnsafe?.user;
            if (user) {
                console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:", user.username);
            }
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function loadOscarState() {
            try {
                showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è...');
                
                const response = await fetch(`${API_BASE_URL}/state`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    oscarState = data.data;
                    updateUI();
                    showNotification('–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.');
                updateUI(); // –û–±–Ω–æ–≤–ª—è–µ–º UI –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
            document.getElementById('hunger-value').textContent = oscarState.hunger;
            document.getElementById('energy-value').textContent = oscarState.energy;
            document.getElementById('mood-value').textContent = oscarState.mood;
            document.getElementById('lives-value').textContent = `${oscarState.lives}/24`;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–æ—Å–æ–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            document.getElementById('hunger-bar').style.width = `${oscarState.hunger}%`;
            document.getElementById('energy-bar').style.width = `${oscarState.energy}%`;
            document.getElementById('mood-bar').style.width = `${oscarState.mood}%`;
            document.getElementById('lives-bar').style.width = `${(oscarState.lives / 24) * 100}%`;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–Ω–∞
            const oscar = document.getElementById('oscar');
            const sleepIndicator = document.getElementById('sleep-indicator');
            
            if (oscarState.isSleeping) {
                oscar.classList.add('blink');
                sleepIndicator.style.display = 'block';
                document.querySelector('.sleep-btn').textContent = '‚òÄÔ∏è –†–∞–∑–±—É–¥–∏—Ç—å';
            } else {
                oscar.classList.remove('blink');
                sleepIndicator.style.display = 'none';
                document.querySelector('.sleep-btn').textContent = 'üí§ –£–ª–æ–∂–∏—Ç—å —Å–ø–∞—Ç—å';
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è (—Ü–≤–µ—Ç –≥–ª–∞–∑)
            const pupils = document.querySelectorAll('.pupil');
            if (oscarState.mood > 70) {
                pupils.forEach(p => p.style.background = '#4ECDC4');
            } else if (oscarState.mood > 30) {
                pupils.forEach(p => p.style.background = '#FFD166');
            } else {
                pupils.forEach(p => p.style.background = '#FF6B6B');
            }
        }
        
        // –î–µ–π—Å—Ç–≤–∏—è
        async function feedOscar() {
            await performAction('feed', '–û—Å–∫–∞—Ä –∫—É—à–∞–µ—Ç... üçñ');
        }
        
        async function playWithOscar() {
            if (oscarState.isSleeping) {
                showNotification('–û—Å–∫–∞—Ä —Å–ø–∏—Ç! –ù–µ –º–µ—à–∞–π—Ç–µ –µ–º—É! üí§');
                return;
            }
            await performAction('play', '–û—Å–∫–∞—Ä –∏–≥—Ä–∞–µ—Ç —Å –ª–∞–∑–µ—Ä–Ω–æ–π —É–∫–∞–∑–∫–æ–π! üî¥');
        }
        
        async function toggleSleep() {
            const action = oscarState.isSleeping ? 'sleep' : 'sleep'; // –û–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
            await performAction(action, oscarState.isSleeping ? '–ë—É–¥–∏–º –û—Å–∫–∞—Ä–∞... ‚òÄÔ∏è' : '–£–∫–ª–∞–¥—ã–≤–∞–µ–º –û—Å–∫–∞—Ä–∞ —Å–ø–∞—Ç—å... üí§');
        }
        
        // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ API
        async function performAction(action, loadingMessage = '–í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ...') {
            showNotification(loadingMessage);
            
            try {
                const user = tg.initDataUnsafe?.user;
                const telegramId = user?.username || `user_${user?.id}` || 'anonymous';
                
                const response = await fetch(`${API_BASE_URL}/action`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: action,
                        telegram_id: telegramId,
                        params: {}
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    oscarState = data.data;
                    updateUI();
                    showNotification(data.message || '–î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!');
                    
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏
                    if (action === 'play') {
                        animateLaser();
                    } else if (action === 'feed') {
                        animateEating();
                    }
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }
        
        // –°–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            const toOwner = document.getElementById('toOwner').value.trim();
            const message = document.getElementById('messageText').value.trim();
            
            if (!toOwner || !message) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }
            
            showNotification('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ... üì®');
            
            try {
                const user = tg.initDataUnsafe?.user;
                const telegramId = user?.username || `user_${user?.id}` || 'anonymous';
                
                const response = await fetch(`${API_BASE_URL}/action`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'message',
                        telegram_id: telegramId,
                        params: {
                            to_owner: toOwner,
                            message: message
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message || '–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                    hideMessageModal();
                    
                    // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
                    document.getElementById('toOwner').value = '';
                    document.getElementById('messageText').value = '';
                } else {
                    showNotification(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }
        
        // –ê–Ω–∏–º–∞—Ü–∏–∏ (–æ—Å—Ç–∞—é—Ç—Å—è —Ç–µ –∂–µ)
        function startAnimations() {
            setInterval(() => {
                if (!oscarState.isSleeping && !laserActive) {
                    moveEyesRandomly();
                }
            }, 3000);
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(loadOscarState, 30000);
        }
        
        function moveEyesRandomly() {
            const pupils = document.querySelectorAll('.pupil');
            const x = Math.random() * 10 - 5;
            const y = Math.random() * 10 - 5;
            
            pupils.forEach(pupil => {
                pupil.style.transform = `translate(${x}px, ${y}px)`;
            });
        }
        
        function animateEating() {
            const oscar = document.getElementById('oscar');
            oscar.classList.add('float');
            
            setTimeout(() => {
                oscar.classList.remove('float');
            }, 1000);
        }
        
        function animateLaser() {
            // ... –∞–Ω–∏–º–∞—Ü–∏—è –ª–∞–∑–µ—Ä–∞ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø—Ä–∏–º–µ—Ä–µ
            // ...
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showNotification(text) {
            const notification = document.getElementById('notification');
            notification.textContent = text;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function showMessageModal() {
            document.getElementById('messageModal').style.display = 'flex';
        }
        
        function hideMessageModal() {
            document.getElementById('messageModal').style.display = 'none';
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –û—Å–∫–∞—Ä–∞
        document.getElementById('oscar').addEventListener('click', async function() {
            if (!oscarState.isSleeping) {
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ "–ø–æ–≥–ª–∞–¥–∏—Ç—å"
                // await performAction('pet', '–ì–ª–∞–¥–∏–º –û—Å–∫–∞—Ä–∞...');
                
                // –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –ª–æ–∫–∞–ª—å–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
                this.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 300);
                showNotification('–û—Å–∫–∞—Ä –º—É—Ä–ª—ã—á–µ—Ç! üòª');
            }
        });
        
        // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
        window.refreshState = async function() {
            await loadOscarState();
        };
    </script>
</body>
</html>
